---
interface Version {
  filename: string;
  label: string;
  hash?: string;
}

interface Props {
  versions: Version[];
  latest: string;
}

const { versions, latest } = Astro.props;
---

<aside class="version-panel">
  <div class="panel-header">
    <span class="panel-title">version history</span>
    <span class="panel-count">[{versions.length}]</span>
  </div>

  {versions.length === 0 ? (
    <div class="no-versions">
      <span>no versions yet</span>
    </div>
  ) : (
    <ul class="version-list">
      {versions.map((v, i) => (
        <li
          class={`version-item${v.filename === latest ? ' version-item--active' : ''}`}
          data-url={`/resumes/${v.filename}${v.hash ? `?v=${v.hash}` : ''}`}
          data-filename={v.filename}
          role="button"
          tabindex="0"
          title={v.filename}
        >
          <span class="version-prefix">{i === 0 ? '▶' : ' '}</span>
          <span class="version-label">{v.label}</span>
          {i === 0 && <span class="version-badge">latest</span>}
        </li>
      ))}
    </ul>
  )}
</aside>

<style>
  .version-panel {
    display: flex;
    flex-direction: column;
    background: #000;
    border: 1px solid var(--dim, #3a4a3a);
    font-family: 'JetBrains Mono', 'Courier New', Courier, monospace;
    min-width: 0;
    height: 100%;
  }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px 12px;
    border-bottom: 1px solid var(--dim, #3a4a3a);
    flex-shrink: 0;
  }

  .panel-title {
    color: var(--primary, #98c379);
    font-size: 0.72rem;
    letter-spacing: 0.08em;
    text-transform: lowercase;
  }

  .panel-count {
    color: var(--muted, #5a6a5a);
    font-size: 0.72rem;
  }

  .no-versions {
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
    padding: 20px;
    color: var(--muted, #5a6a5a);
    font-size: 0.72rem;
    letter-spacing: 0.06em;
  }

  .version-list {
    list-style: none;
    margin: 0;
    padding: 4px 0;
    overflow-y: auto;
    flex: 1;
    scrollbar-width: thin;
    scrollbar-color: #3d3d3d #1a1a1a;
  }

  .version-list::-webkit-scrollbar { width: 4px; }
  .version-list::-webkit-scrollbar-track { background: #1a1a1a; }
  .version-list::-webkit-scrollbar-thumb { background: #3d3d3d; }
  .version-list::-webkit-scrollbar-thumb:hover { background: var(--primary, #98c379); }

  .version-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    cursor: pointer;
    color: var(--muted, #5a6a5a);
    font-size: 0.78rem;
    letter-spacing: 0.04em;
    border-left: 2px solid transparent;
    transition: color 0.12s, border-color 0.12s, background 0.12s;
    user-select: none;
  }

  .version-item:hover {
    color: var(--primary, #98c379);
    background: rgba(152, 195, 121, 0.06);
    border-left-color: var(--dim, #3a4a3a);
  }

  .version-item:focus-visible {
    outline: 1px dashed var(--primary, #98c379);
    outline-offset: -2px;
  }

  .version-item--active {
    color: var(--primary, #98c379);
    border-left-color: var(--primary, #98c379);
    background: rgba(152, 195, 121, 0.05);
  }

  .version-prefix {
    font-size: 0.62rem;
    width: 10px;
    flex-shrink: 0;
    color: var(--primary, #98c379);
  }

  .version-label { flex: 1; }

  .version-badge {
    font-size: 0.58rem;
    letter-spacing: 0.08em;
    color: #000;
    background: var(--primary, #98c379);
    padding: 1px 4px;
    flex-shrink: 0;
  }
</style>

<script>
  document.querySelectorAll('.version-item').forEach((item) => {
    const activate = () => {
      const url = item.dataset.url;
      if (!url) return;

      // Update active state
      document.querySelectorAll('.version-item').forEach((el) => {
        el.classList.remove('version-item--active');
        el.querySelector('.version-prefix').textContent = ' ';
      });
      item.classList.add('version-item--active');
      item.querySelector('.version-prefix').textContent = '▶';

      // Update toolbar prompt
      const promptEl = document.querySelector('.prompt');
      if (promptEl) promptEl.textContent = item.dataset.filename;

      window.dispatchEvent(new CustomEvent('load-version', { detail: { url } }));
    };

    item.addEventListener('click', activate);
    item.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); activate(); }
    });
  });
</script>
